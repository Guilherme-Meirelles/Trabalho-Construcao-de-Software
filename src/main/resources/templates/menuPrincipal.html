<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ToDaily</title>
    <link rel="stylesheet" href="/css/sidebar.css" />
    <link rel="stylesheet" href="/css/menuPrincipal.css" />
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
<div class="app-container">

    <!-- Importa a Sidebar do fragment -->
    <div th:replace="~{sidebar :: sidebar}"></div>

    <!-- Conteúdo Principal -->
    <main class="conteudo">
        <div class="titulo">
            <div class="titulo-info">
                <h2 id="titulo-principal">Para Hoje</h2>
                <span id="subtitulo-principal">- 21/11/24</span>
            </div>
            <div class="titulo-acoes">
                <button class="btn-filtro" id="btnFiltro">
                    <i data-lucide="filter"></i>
                </button>
                <button class="btn-ordenar" id="btnOrdenar">
                    <i data-lucide="arrow-up-down"></i>
                </button>
            </div>
        </div>

        <div class="add-tarefa" id="btnAddTarefa">
            <i data-lucide="plus"></i>
            <span>Adicionar Tarefa</span>
        </div>

        <!-- Container para as tarefas -->
        <div class="container-tarefas" id="containerTarefas">
            <!-- As tarefas serão adicionadas aqui dinamicamente -->
        </div>

        <!-- Menu de Contexto da Tarefa -->
        <div class="context-menu" id="menuContextoTarefa" style="display: none;">
            <button class="context-menu-item" id="btnEditarTarefa">Editar Tarefa</button>
        </div>

        <!-- Menu de Filtro -->
        <div class="menu-filtro" id="menuFiltro" style="display: none;">
            <h4 class="menu-filtro-titulo">Filtrar por:</h4>
            <button class="menu-filtro-item" data-filtro="todas">
                <i data-lucide="circle"></i> Todas as tarefas
            </button>
            <button class="menu-filtro-item" data-filtro="andamento">
                <i data-lucide="circle"></i> Tarefas em andamento
            </button>
            <button class="menu-filtro-item" data-filtro="concluidas">
                <i data-lucide="circle"></i> Tarefas concluídas
            </button>
            <button class="menu-filtro-item" data-filtro="atrasadas">
                <i data-lucide="circle"></i> Atrasadas
            </button>
            <button class="menu-filtro-item" data-filtro="titulo">
                <i data-lucide="circle"></i> Título
            </button>
            <button class="menu-filtro-item" data-filtro="responsavel">
                <i data-lucide="circle"></i> Responsável
            </button>
        </div>

        <!-- Menu de Ordenação -->
        <div class="menu-filtro" id="menuOrdenar" style="display: none;">
            <h4 class="menu-filtro-titulo">Ordenar por:</h4>
            <button class="menu-filtro-item" data-ordem="data-inicio">
                <i data-lucide="circle"></i> Data de início
            </button>
            <button class="menu-filtro-item" data-ordem="data-fim">
                <i data-lucide="circle"></i> Data de fim
            </button>
            <button class="menu-filtro-item" data-ordem="data-adicao">
                <i data-lucide="circle"></i> Data de adição
            </button>
            <button class="menu-filtro-item" data-ordem="notificacao">
                <i data-lucide="circle"></i> Aviso de notificação
            </button>
            <button class="menu-filtro-item" data-ordem="status">
                <i data-lucide="circle"></i> Status de completude
            </button>
        </div>

        <div class="botoes-flutuantes">
            <button><i data-lucide="plus-circle"></i></button>
            <button><i data-lucide="calendar-days"></i></button>
        </div>
    </main>

</div>

<!-- Modal de Confirmação de Remoção -->
<div class="overlay-tarefa" id="modalConfirmarRemocao" style="display: none;">
    <div class="modal-remover">
        <p class="modal-remover-mensagem">Deseja realmente remover esta tarefa?</p>
        <div class="modal-remover-botoes">
            <button class="btn-remover-nao" id="btnCancelarRemocao">Não</button>
            <button class="btn-remover-sim" id="btnConfirmarRemocao">Sim</button>
        </div>
    </div>
</div>

<!-- Modal Adicionar Tarefa -->
<div class="overlay-tarefa" id="modalAddTarefa" style="display: none;">
    <div class="modal-tarefa">
        <h3 class="titulo-modal-tarefa">Adicionar Tarefa</h3>
        <form class="form-tarefa">
            <div class="campo-tarefa">
                <label>Lista*:</label>
                <select id="tarefaLista">
                    <option value="">Selecione uma lista...</option>
                    <option value="para-hoje">Para Hoje</option>
                    <option value="faculdade">Faculdade</option>
                    <option value="casa">Casa</option>
                    <option value="remomeada">Remomeada</option>
                </select>
            </div>

            <div class="campo-tarefa">
                <label>Título*:</label>
                <input type="text" id="tarefaTitulo" placeholder="Digite o título da tarefa" />
            </div>

            <div class="campo-tarefa">
                <label>Descrição:</label>
                <textarea id="tarefaDescricao" rows="3" placeholder="Adicione uma descrição (opcional)"></textarea>
            </div>

            <div class="campo-tarefa">
                <label>Data de Fim:</label>
                <input type="date" id="tarefaDataFim" />
            </div>

            <div class="campo-tarefa">
                <label>Responsáveis:</label>
                <select id="tarefaResponsavel">
                    <option value="">Selecione...</option>
                    <option value="matheus">Matheus</option>
                    <option value="usuario2">Usuário 2</option>
                    <option value="usuario3">Usuário 3</option>
                </select>
            </div>

            <div class="campo-tarefa-row">
                <div class="campo-tarefa-checkbox">
                    <label>Checklist:</label>
                    <button type="button" class="btn-checklist" id="btnChecklist">
                        <i data-lucide="list"></i>
                    </button>
                </div>

                <div class="campo-tarefa-checkbox">
                    <label>Notificações:</label>
                    <input type="checkbox" id="tarefaNotificacoes" class="toggle-switch" />
                </div>

                <div class="campo-tarefa-checkbox">
                    <label>Anexo(s):</label>
                    <button type="button" class="btn-anexo" id="btnAnexo">
                        <i data-lucide="paperclip"></i>
                    </button>
                </div>
            </div>

            <div class="botoes-acao-tarefa">
                <button type="button" class="btn-cancelar-tarefa" id="btnCancelarTarefa">Cancelar</button>
                <button type="button" class="btn-ok-tarefa" id="btnOkTarefa">OK</button>
            </div>
        </form>
    </div>
</div>

<!-- Importa os Modais do fragment -->
<div th:replace="~{sidebar :: modais}"></div>

<!-- Importa os Scripts do fragment -->
<div th:replace="~{sidebar :: scripts}"></div>

<script>
    // Mapeamento dos nomes das listas
    const nomesListas = {
        'para-hoje': 'Para Hoje',
        'faculdade': 'Faculdade',
        'casa': 'Casa',
        'remomeada': 'Remomeada'
    };

    // Array para armazenar as tarefas
    let tarefas = [];
    let tarefaSelecionada = null;
    let listaAtual = 'para-hoje'; // Lista atual sendo visualizada

    // Script para abrir/fechar modal de Adicionar Tarefa
    document.addEventListener('DOMContentLoaded', function() {
        const btnAddTarefa = document.getElementById('btnAddTarefa');
        const modalAddTarefa = document.getElementById('modalAddTarefa');
        const btnCancelarTarefa = document.getElementById('btnCancelarTarefa');
        const btnOkTarefa = document.getElementById('btnOkTarefa');
        const containerTarefas = document.getElementById('containerTarefas');
        const menuContextoTarefa = document.getElementById('menuContextoTarefa');
        const btnEditarTarefa = document.getElementById('btnEditarTarefa');
        const tituloModalTarefa = document.querySelector('.titulo-modal-tarefa');
        const modalConfirmarRemocao = document.getElementById('modalConfirmarRemocao');
        const btnCancelarRemocao = document.getElementById('btnCancelarRemocao');
        const btnConfirmarRemocao = document.getElementById('btnConfirmarRemocao');
        let tarefaParaRemover = null;

        const btnFiltro = document.getElementById('btnFiltro');
        const btnOrdenar = document.getElementById('btnOrdenar');
        const menuFiltro = document.getElementById('menuFiltro');
        const menuOrdenar = document.getElementById('menuOrdenar');
        let filtroAtivo = 'todas';
        let ordenacaoAtiva = null;

        // Abrir/fechar menus de filtro e ordenação
        btnFiltro.addEventListener('click', function(e) {
            e.stopPropagation();
            const isVisible = menuFiltro.style.display === 'block';
            menuFiltro.style.display = isVisible ? 'none' : 'block';
            menuOrdenar.style.display = 'none';

            if (!isVisible) {
                const rect = btnFiltro.getBoundingClientRect();
                menuFiltro.style.left = rect.left + 'px';
                menuFiltro.style.top = (rect.bottom + 5) + 'px';
            }
        });

        btnOrdenar.addEventListener('click', function(e) {
            e.stopPropagation();
            const isVisible = menuOrdenar.style.display === 'block';
            menuOrdenar.style.display = isVisible ? 'none' : 'block';
            menuFiltro.style.display = 'none';

            if (!isVisible) {
                const rect = btnOrdenar.getBoundingClientRect();
                menuOrdenar.style.left = rect.left + 'px';
                menuOrdenar.style.top = (rect.bottom + 5) + 'px';
            }
        });

        // Fechar menus ao clicar fora
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.menu-filtro') && !e.target.closest('.btn-filtro') && !e.target.closest('.btn-ordenar')) {
                menuFiltro.style.display = 'none';
                menuOrdenar.style.display = 'none';
            }
            menuContextoTarefa.style.display = 'none';
        });

        // Aplicar filtros
        document.querySelectorAll('#menuFiltro .menu-filtro-item').forEach(item => {
            item.addEventListener('click', function() {
                filtroAtivo = this.dataset.filtro;

                // Atualizar indicador visual
                document.querySelectorAll('#menuFiltro .menu-filtro-item').forEach(btn => {
                    btn.classList.remove('active');
                });
                this.classList.add('active');

                renderizarTarefas(listaAtual);
                menuFiltro.style.display = 'none';
                lucide.createIcons();
            });
        });

        // Aplicar ordenação
        document.querySelectorAll('#menuOrdenar .menu-filtro-item').forEach(item => {
            item.addEventListener('click', function() {
                ordenacaoAtiva = this.dataset.ordem;

                // Atualizar indicador visual
                document.querySelectorAll('#menuOrdenar .menu-filtro-item').forEach(btn => {
                    btn.classList.remove('active');
                });
                this.classList.add('active');

                renderizarTarefas(listaAtual);
                menuOrdenar.style.display = 'none';
                lucide.createIcons();
            });
        });

        // Fechar menu de contexto ao clicar fora
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.menu-filtro') && !e.target.closest('.btn-filtro') && !e.target.closest('.btn-ordenar')) {
                menuFiltro.style.display = 'none';
                menuOrdenar.style.display = 'none';
            }
            menuContextoTarefa.style.display = 'none';
        });

        // Evitar que o menu feche ao clicar nele
        menuContextoTarefa.addEventListener('click', function(e) {
            e.stopPropagation();
        });

        // Modal de confirmação de remoção
        btnCancelarRemocao.addEventListener('click', function() {
            modalConfirmarRemocao.style.display = 'none';
            tarefaParaRemover = null;
        });

        btnConfirmarRemocao.addEventListener('click', function() {
            if (tarefaParaRemover) {
                tarefas = tarefas.filter(t => t.id !== tarefaParaRemover.id);
                renderizarTarefas(tarefaParaRemover.lista);
                modalConfirmarRemocao.style.display = 'none';
                tarefaParaRemover = null;
            }
        });

        // Fechar modal de confirmação ao clicar no overlay
        modalConfirmarRemocao.addEventListener('click', function(e) {
            if (e.target === modalConfirmarRemocao) {
                modalConfirmarRemocao.style.display = 'none';
                tarefaParaRemover = null;
            }
        });

        // Abrir modal
        btnAddTarefa.addEventListener('click', function() {
            modalAddTarefa.style.display = 'flex';
        });

        // Fechar modal ao clicar no overlay
        modalAddTarefa.addEventListener('click', function(e) {
            if (e.target === modalAddTarefa) {
                modalAddTarefa.style.display = 'none';
                limparFormulario();
            }
        });

        // Fechar modal ao clicar em Cancelar
        btnCancelarTarefa.addEventListener('click', function() {
            modalAddTarefa.style.display = 'none';
            limparFormulario();
        });

        // Ação do botão OK - Adicionar ou Editar tarefa
        btnOkTarefa.addEventListener('click', function() {
            const lista = document.getElementById('tarefaLista').value;
            const titulo = document.getElementById('tarefaTitulo').value.trim();
            const descricao = document.getElementById('tarefaDescricao').value.trim();
            const dataFim = document.getElementById('tarefaDataFim').value;
            const responsavel = document.getElementById('tarefaResponsavel').value;
            const notificacoes = document.getElementById('tarefaNotificacoes').checked;

            // Validação básica
            if (!lista || !titulo) {
                alert('Por favor, preencha os campos obrigatórios (Lista e Título)');
                return;
            }

            if (tarefaSelecionada) {
                // Modo Edição
                tarefaSelecionada.lista = lista;
                tarefaSelecionada.titulo = titulo;
                tarefaSelecionada.descricao = descricao;
                tarefaSelecionada.dataFim = dataFim;
                tarefaSelecionada.responsavel = responsavel;
                tarefaSelecionada.notificacoes = notificacoes;

                console.log('Tarefa editada!', tarefaSelecionada);
            } else {
                // Modo Criação
                const tarefa = {
                    id: Date.now(),
                    lista: lista,
                    titulo: titulo,
                    descricao: descricao,
                    dataFim: dataFim,
                    responsavel: responsavel,
                    notificacoes: notificacoes,
                    concluida: false
                };

                // Adicionar tarefa ao array
                tarefas.push(tarefa);

                console.log('Tarefa adicionada!', tarefa);
            }

            // Atualizar título da página
            listaAtual = lista;
            atualizarTituloPagina(lista);

            // Renderizar tarefas
            renderizarTarefas(lista);

            // Fechar modal e limpar formulário
            modalAddTarefa.style.display = 'none';
            limparFormulario();
            tarefaSelecionada = null;
            tituloModalTarefa.textContent = 'Adicionar Tarefa';
        });

        // Função para limpar o formulário
        function limparFormulario() {
            document.getElementById('tarefaLista').value = '';
            document.getElementById('tarefaTitulo').value = '';
            document.getElementById('tarefaDescricao').value = '';
            document.getElementById('tarefaDataFim').value = '';
            document.getElementById('tarefaResponsavel').value = '';
            document.getElementById('tarefaNotificacoes').checked = false;
        }

        // Função para preencher o formulário com dados da tarefa (para edição)
        function preencherFormulario(tarefa) {
            document.getElementById('tarefaLista').value = tarefa.lista;
            document.getElementById('tarefaTitulo').value = tarefa.titulo;
            document.getElementById('tarefaDescricao').value = tarefa.descricao;
            document.getElementById('tarefaDataFim').value = tarefa.dataFim;
            document.getElementById('tarefaResponsavel').value = tarefa.responsavel;
            document.getElementById('tarefaNotificacoes').checked = tarefa.notificacoes;
        }

        // Editar tarefa
        btnEditarTarefa.addEventListener('click', function() {
            if (tarefaSelecionada) {
                tituloModalTarefa.textContent = 'Editar Tarefa';
                preencherFormulario(tarefaSelecionada);
                modalAddTarefa.style.display = 'flex';
                menuContextoTarefa.style.display = 'none';
            }
        });

        // Função para atualizar o título da página
        function atualizarTituloPagina(listaId) {
            const tituloPrincipal = document.getElementById('titulo-principal');
            tituloPrincipal.textContent = nomesListas[listaId] || 'Para Hoje';
        }

        // Função para renderizar tarefas
        function renderizarTarefas(listaFiltro) {
            containerTarefas.innerHTML = '';

            // Filtrar tarefas pela lista atual
            let tarefasFiltradas = tarefas.filter(t => t.lista === listaFiltro);

            // Aplicar filtro
            if (filtroAtivo === 'andamento') {
                tarefasFiltradas = tarefasFiltradas.filter(t => !t.concluida);
            } else if (filtroAtivo === 'concluidas') {
                tarefasFiltradas = tarefasFiltradas.filter(t => t.concluida);
            } else if (filtroAtivo === 'atrasadas') {
                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);
                tarefasFiltradas = tarefasFiltradas.filter(t => {
                    if (!t.dataFim) return false;
                    const dataFim = new Date(t.dataFim + 'T00:00:00');
                    return dataFim < hoje && !t.concluida;
                });
            }

            // Aplicar ordenação
            if (ordenacaoAtiva === 'data-inicio') {
                tarefasFiltradas.sort((a, b) => a.id - b.id);
            } else if (ordenacaoAtiva === 'data-fim') {
                tarefasFiltradas.sort((a, b) => {
                    if (!a.dataFim) return 1;
                    if (!b.dataFim) return -1;
                    return new Date(a.dataFim) - new Date(b.dataFim);
                });
            } else if (ordenacaoAtiva === 'data-adicao') {
                tarefasFiltradas.sort((a, b) => b.id - a.id);
            } else if (ordenacaoAtiva === 'notificacao') {
                tarefasFiltradas.sort((a, b) => b.notificacoes - a.notificacoes);
            } else if (ordenacaoAtiva === 'status') {
                tarefasFiltradas.sort((a, b) => a.concluida - b.concluida);
            }

            if (tarefasFiltradas.length === 0) {
                return;
            }

            // Criar elementos de tarefa
            tarefasFiltradas.forEach(tarefa => {
                const tarefaEl = document.createElement('div');
                tarefaEl.className = 'tarefa-item';
                tarefaEl.dataset.id = tarefa.id;

                // Adicionar menu de contexto ao clicar com o botão direito
                tarefaEl.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    tarefaSelecionada = tarefa;

                    // Posicionar menu
                    menuContextoTarefa.style.left = e.pageX + 'px';
                    menuContextoTarefa.style.top = e.pageY + 'px';
                    menuContextoTarefa.style.display = 'block';
                });

                // Criar checkbox
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'tarefa-checkbox';
                checkbox.checked = tarefa.concluida;
                checkbox.addEventListener('change', function() {
                    toggleTarefaConcluida(tarefa.id);
                });

                // Criar conteúdo da tarefa
                const conteudo = document.createElement('div');
                conteudo.className = 'tarefa-conteudo';

                const titulo = document.createElement('div');
                titulo.className = 'tarefa-titulo';
                titulo.textContent = tarefa.titulo;
                if (tarefa.concluida) {
                    titulo.classList.add('concluida');
                }

                conteudo.appendChild(titulo);

                // Adicionar descrição se existir
                if (tarefa.descricao) {
                    const descricao = document.createElement('div');
                    descricao.className = 'tarefa-descricao';
                    descricao.textContent = tarefa.descricao;
                    conteudo.appendChild(descricao);
                }

                // Adicionar informações extras se existirem
                if (tarefa.dataFim || tarefa.responsavel) {
                    const info = document.createElement('div');
                    info.className = 'tarefa-info';

                    if (tarefa.dataFim) {
                        const data = document.createElement('span');
                        data.className = 'tarefa-data';
                        data.innerHTML = `<i data-lucide="calendar"></i> ${formatarData(tarefa.dataFim)}`;
                        info.appendChild(data);
                    }

                    if (tarefa.responsavel) {
                        const resp = document.createElement('span');
                        resp.className = 'tarefa-responsavel';
                        resp.innerHTML = `<i data-lucide="user"></i> ${tarefa.responsavel}`;
                        info.appendChild(resp);
                    }

                    conteudo.appendChild(info);
                }

                // Botão de excluir
                const btnExcluir = document.createElement('button');
                btnExcluir.className = 'tarefa-btn-excluir';
                btnExcluir.innerHTML = '<i data-lucide="trash-2"></i>';
                btnExcluir.addEventListener('click', function() {
                    excluirTarefa(tarefa.id, listaFiltro);
                });

                tarefaEl.appendChild(checkbox);
                tarefaEl.appendChild(conteudo);
                tarefaEl.appendChild(btnExcluir);

                containerTarefas.appendChild(tarefaEl);
            });

            // Reinicializar ícones Lucide
            lucide.createIcons();
        }

        // Função para alternar tarefa concluída
        function toggleTarefaConcluida(tarefaId) {
            const tarefa = tarefas.find(t => t.id === tarefaId);
            if (tarefa) {
                tarefa.concluida = !tarefa.concluida;
                renderizarTarefas(tarefa.lista);
            }
        }

        // Função para excluir tarefa
        function excluirTarefa(tarefaId, listaAtual) {
            const tarefa = tarefas.find(t => t.id === tarefaId);
            if (tarefa) {
                tarefaParaRemover = tarefa;
                modalConfirmarRemocao.style.display = 'flex';
            }
        }

        // Função para formatar data
        function formatarData(dataString) {
            const data = new Date(dataString + 'T00:00:00');
            return data.toLocaleDateString('pt-BR');
        }

        // Inicializar ícones Lucide
        lucide.createIcons();
    });
</script>

</body>
</html>