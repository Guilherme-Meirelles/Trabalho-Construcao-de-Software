<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ToDaily - Áreas de Trabalho</title>
    <link rel="stylesheet" href="/css/sidebar.css" />
    <link rel="stylesheet" href="/css/areasTrabalho.css" />
    <link rel="stylesheet" href="/css/menuPrincipal.css" />
    <link rel="stylesheet" href="/css/acessibilidade.css" />
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
<div class="app-container">
    <!-- Sidebar (importada) -->
    <div th:replace="~{sidebar :: sidebar}"></div>

    <!-- Conteúdo principal - Áreas de Trabalho -->
    <main class="conteudo-areas">
        <div class="titulo">
            <h2>Áreas de Trabalho</h2>
        </div>

    <div class="areas-grid" id="areasGrid">

        <!-- Renderiza cada área do usuário -->
        <div class="area-card"
            th:each="area : ${areas}"
            th:data-id="${area.id}"
            th:data-nome="${area.nome}"
            onclick="abrirArea(this)"
            oncontextmenu="abrirMenuContexto(event, this)">
            <h3 th:text="${area.nome}"></h3>
        </div>

        <!-- Card de adicionar área -->
        <div class="area-card area-add" onclick="abrirModalNovaArea()">
            <i data-lucide="plus-circle" data-size="52"></i>
        </div>

    </div>

        <!-- Botões de ação flutuantes -->
        <div class="acoes-flutuantes">
            <button class="btn-acao" title="Compartilhar" onclick="abrirModalCompartilhar()">
                <i data-lucide="share-2"></i>
            </button>
            <button class="btn-acao" title="Excluir" onclick="abrirModalExcluir()">
                <i data-lucide="trash-2"></i>
            </button>
            <button class="btn-acao" title="Configurações" onclick="abrirModalGerenciamento()">
                <i data-lucide="settings"></i>
            </button>
        </div>
    </main>

    <!-- Modal de Perfil (importado) -->
    <div th:replace="~{sidebar :: modalPerfil}"></div>

    <!-- Modal para criar/renomear área -->
    <div id="modalArea" class="overlay-modal" style="display: none;" onclick="fecharModalArea()">
        <div class="modal-nova-area" onclick="event.stopPropagation()">
            <h2 class="titulo-modal" id="tituloModalArea">Nova Área de Trabalho</h2>

            <form class="formulario-nova-area" onsubmit="salvarArea(event)">
                <input type="hidden" id="areaIdEdicao">
                <div class="campo-modal">
                    <label>Nome da área:*</label>
                    <input type="text" id="inputNomeArea" placeholder="Ex: Projetos Pessoais" autofocus required />
                </div>

                <div class="botoes-modal">
                    <button type="submit" class="btn-criar">Criar</button>
                    <button type="button" class="btn-cancelar-modal" onclick="fecharModalArea()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Compartilhamento -->
    <div id="modalCompartilhar" class="overlay-modal" style="display: none;" onclick="fecharModalCompartilhar()">
        <div class="modal-compartilhar" onclick="event.stopPropagation()">
            <h2 class="titulo-modal">Compartilhar Área de Trabalho</h2>

            <!-- Lista de áreas para selecionar -->
            <div class="lista-areas-compartilhar">
                <!-- As áreas serão geradas pelo JS -->
            </div>

            <!-- Métodos de compartilhamento -->
            <div class="secao-metodos-compartilhamento">
                <h3>Compartilhar via:</h3>

                <div class="metodos-compartilhamento">
                    <button class="btn-metodo-compartilhar" id="btnGoogle" onclick="compartilharVia('google')" disabled>
                        <i data-lucide="mail"></i>
                        Google
                    </button>

                    <button class="btn-metodo-compartilhar" id="btnMicrosoft" onclick="compartilharVia('microsoft')" disabled>
                        <i data-lucide="briefcase"></i>
                        Microsoft
                    </button>

                    <button class="btn-metodo-compartilhar" id="btnGithub" onclick="compartilharVia('github')" disabled>
                        <i data-lucide="github"></i>
                        GitHub
                    </button>

                    <button class="btn-link-compartilhar" id="btnLink" onclick="gerarLinkCompartilhamento()" disabled>
                        <i data-lucide="link"></i>
                        Copiar Link
                    </button>
                </div>

                <div class="botoes-modal">
                    <button type="button" class="btn-cancelar-modal" onclick="fecharModalCompartilhar()">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Exclusão -->
    <div id="modalExcluir" class="overlay-modal" style="display: none;" onclick="fecharModalExcluir()">
        <div class="modal-excluir" onclick="event.stopPropagation()">
            <h2 class="titulo-modal">Excluir Áreas de Trabalho</h2>

            <!-- Lista de áreas para excluir -->
            <div class="lista-areas-excluir" id="listaAreasExcluir">
                <!-- As áreas serão inseridas dinamicamente via JS -->
            </div>

            <div class="botoes-modal">
                <button type="button" class="btn-excluir-areas" id="btnConfirmarExclusao" onclick="confirmarExclusao()" disabled>
                    <i data-lucide="trash-2"></i>
                    Excluir Selecionadas
                </button>
                <button type="button" class="btn-cancelar-modal" onclick="fecharModalExcluir()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Menu de contexto (botão direito) -->
    <div id="menuContexto" class="menu-contexto" style="display: none;">
        <button class="item-menu-contexto" onclick="renomearAreaContexto()">
            <i data-lucide="edit-3"></i>
            Renomear
        </button>
    </div>

    <!-- Modal de Gerenciamento -->
    <div id="modalGerenciamento" class="overlay-modal" style="display: none;" onclick="fecharModalGerenciamento()">
        <div class="modal-gerenciamento" onclick="event.stopPropagation()">
            <!-- Etapa 1: Seleção de área -->
            <div id="etapaSelecaoArea" style="display: block;">
                <h2 class="titulo-modal">Gerenciar Áreas de Trabalho</h2>

                <div class="lista-areas-gerenciar">
                    <!-- JS vai preencher as áreas aqui -->
                </div>

                <div class="botoes-modal">
                    <button type="button" class="btn-avancar-gerenciar" id="btnAvancarGerenciar" onclick="avancarParaDetalhes()" disabled>
                        Avançar
                        <i data-lucide="arrow-right"></i>
                    </button>
                    <button type="button" class="btn-cancelar-modal" onclick="fecharModalGerenciamento()">Cancelar</button>
                </div>
            </div>

            <!-- Etapa 2: Detalhes da área -->
            <div id="etapaDetalhesArea" style="display: none;">
                <div class="detalhes-area-header">
                    <button class="btn-voltar-gerenciar" onclick="voltarParaSelecao()">
                        <i data-lucide="arrow-left"></i>
                    </button>
                    <h3 id="tituloAreaDetalhes">Área de Trabalho</h3>
                </div>

                <div class="menu-detalhes-area">
                    <button class="item-menu-detalhes" onclick="abrirMembros()">
                        <div class="info-item">
                            <i data-lucide="users"></i>
                            <div class="texto-item">
                                <span class="titulo-item">Membros</span>
                                <span class="subtitulo-item">Gerencie quem tem acesso</span>
                            </div>
                        </div>
                    </button>

                    <button class="item-menu-detalhes" onclick="abrirSolicitacoes()">
                        <div class="info-item">
                            <i data-lucide="mail"></i>
                            <div class="texto-item">
                                <span class="titulo-item">Solicitações</span>
                                <span class="subtitulo-item">Pedidos de acesso pendentes</span>
                            </div>
                        </div>
                    </button>
                </div>

                <div class="botoes-modal">
                    <button type="button" class="btn-cancelar-modal" onclick="fecharModalGerenciamento()">Fechar</button>
                </div>
            </div>

            <!-- Etapa 3: Lista de membros -->
            <div id="etapaMembros" style="display: none;">
                <div class="detalhes-area-header">
                    <button class="btn-voltar-gerenciar" onclick="voltarParaDetalhes()">
                        <i data-lucide="arrow-left"></i>
                    </button>
                    <h3>Membros</h3>
                </div>

                <div class="lista-membros" id="listaMembros">
                    <!-- JS vai preencher as áreas aqui -->
                </div>

                <div class="botoes-modal">
                    <button type="button" class="btn-cancelar-modal" onclick="fecharModalGerenciamento()">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Alteração de Permissão -->
    <div id="modalPermissao" class="overlay-modal" style="display: none;" onclick="fecharModalPermissao()">
        <div class="modal-permissao" onclick="event.stopPropagation()">
            <h2 class="titulo-modal" id="tituloModalPermissao">Alterar Permissão</h2>
            <p style="color: #b0b0b0; font-size: 14px; margin-bottom: 25px;" id="descModalPermissao">
                Selecione o nível de permissão para este membro
            </p>

            <div class="opcoes-permissao">
                <div class="opcao-permissao" onclick="selecionarPermissao('editar')">
                    <input type="radio" name="permissaoMembro" id="perm-editar" value="editar">
                    <label for="perm-editar">
                        <span class="titulo-permissao">Pode editar</span>
                        <span class="desc-permissao">Pode visualizar, criar e editar tarefas</span>
                    </label>
                </div>

                <div class="opcao-permissao" onclick="selecionarPermissao('visualizar')">
                    <input type="radio" name="permissaoMembro" id="perm-visualizar" value="visualizar">
                    <label for="perm-visualizar">
                        <span class="titulo-permissao">Pode visualizar</span>
                        <span class="desc-permissao">Apenas visualizar tarefas, sem editar</span>
                    </label>
                </div>
            </div>

            <div class="botoes-modal">
                <button type="button" class="btn-criar" id="btnSalvarPermissao" onclick="salvarPermissao()">Salvar</button>
                <button type="button" class="btn-cancelar-modal" onclick="fecharModalPermissao()">Cancelar</button>
            </div>
        </div>
    </div>
</div>

<!-- Importa o Botão de Acessibilidade -->
<div th:replace="~{acessibilidade :: acessibilidade}"></div>

<!-- Importa o Script de Acessibilidade -->
<div th:replace="~{acessibilidade :: acessibilidade-script}"></div>

<!-- Importa os Modais do fragment -->
<div th:replace="~{sidebar :: modais}"></div>

<!-- Importa os Scripts do fragment -->
<div th:replace="~{sidebar :: scripts}"></div>

<script>
    let areaAtualContexto = { id: null, nome: null };
    let modoEdicao = false; // false = criar, true = renomear
    let areaSelecionadaCompartilhar = null;
    let areasSelecionadasExcluir = [];
    let areaSelecionadaGerenciar = null;
    let nomeAreaGerenciar = null;
    let membroAtualPermissao = { id: null, nome: null, permissaoAtual: null };
    let membroAtualId = null;    // ID do usuário logado
    let membroCriadorId = null;  // ID do criador da área selecionada

    function abrirModalNovaArea() {
        modoEdicao = false;
        document.getElementById('tituloModalArea').textContent = 'Nova Área de Trabalho';
        document.getElementById('inputNomeArea').value = '';
        document.getElementById('inputNomeArea').placeholder = 'Ex: Projetos Pessoais';
        document.querySelector('.btn-criar').textContent = 'Criar';
        document.getElementById('modalArea').style.display = 'flex';
        document.getElementById('inputNomeArea').focus();
        setTimeout(() => lucide.createIcons(), 10);
    }

    function fecharModalArea() {
        document.getElementById('modalArea').style.display = 'none';
        document.getElementById('inputNomeArea').value = '';
    }

    function adicionarCardArea(id, nome) {
        const grid = document.getElementById("areasGrid");

        const card = document.createElement("div");
        card.className = "area-card";
        card.setAttribute("data-nome", nome);
        card.setAttribute("data-id", id);
        card.onclick = () => abrirArea(id);
        card.oncontextmenu = (e) => abrirMenuContexto(e, card);

        const h3 = document.createElement("h3");
        h3.textContent = nome;

        card.appendChild(h3);
        grid.insertBefore(card, grid.lastElementChild); // insere antes do "+"

        lucide.createIcons(); // atualiza ícones se necessário
    }

    function atualizarNomeNoCard(id, novoNome) {
        const card = document.querySelector(`.area-card[data-id="${id}"]`);
        if (card) {
            const h3 = card.querySelector("h3");
            if (h3) h3.textContent = novoNome;
            card.dataset.nome = novoNome;
        }
    }

    function salvarArea(event) {
        event.preventDefault();

        const id = document.getElementById("areaIdEdicao").value;
        const nome = document.getElementById("inputNomeArea").value.trim();
        if (!nome) {
            alert("Nome inválido");
            return;
        }

        if (!id) {
            fetch("/areasTrabalho/criar", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: `nome=${encodeURIComponent(nome)}`
            })
            .then(res => res.text())
            .then(newId => {
                if (newId === "NOT_LOGGED") {
                    alert("Você precisa estar logado.");
                    window.location.href = "/login";
                    return;
                }
                adicionarCardArea(newId, nome);
                fecharModalArea();
                document.getElementById("areaIdEdicao").value = "";
            });
            return;
        }

        console.log(id);
        console.log(encodeURIComponent(id))

        // RENOMEAR (com id)
        fetch(`/areasTrabalho/${encodeURIComponent(id)}/renomear`, {
            method: "PUT",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: `nome=${encodeURIComponent(nome)}`
        })
        .then(res => {
            if (res.status === 200) return res.text();
            if (res.status === 404) throw new Error("NOT_FOUND");
            if (res.status === 403) throw new Error("NOT_OWNER");
            throw new Error("UNKNOWN");
        })
        .then(_ => {
            atualizarNomeNoCard(id, nome);
            fecharModalArea();
            document.getElementById("areaIdEdicao").value = "";
        })
        .catch(err => {
            if (err.message === "NOT_FOUND") alert("Área não encontrada.");
            else if (err.message === "NOT_OWNER") alert("Você não tem permissão para renomear esta área.");
            else alert("Erro ao renomear área.");
            fecharModalArea();
        });
    }

    function abrirArea(elemento) {
        const id = elemento.dataset.id;
        const name = elemento.dataset.nome
        window.location.href = `/areasTrabalho/${name}`;
    }

    // Menu de contexto (botão direito)
    function abrirMenuContexto(event, elemento) {
        event.preventDefault();
        event.stopPropagation();

        const id = elemento.dataset.id;
        const nome = elemento.dataset.nome;

        areaAtualContexto.id = id;
        areaAtualContexto.nome = nome;

        const menu = document.getElementById('menuContexto');
        menu.style.display = 'block';
        menu.style.left = event.pageX + 'px';
        menu.style.top = event.pageY + 'px';

        setTimeout(() => lucide.createIcons(), 10);
    }

    function fecharMenuContexto() {
        document.getElementById('menuContexto').style.display = 'none';
    }

    function renomearAreaContexto() {
        fecharMenuContexto();
        modoEdicao = true;
        
        document.getElementById('tituloModalArea').textContent = 'Renomear Área de Trabalho';
        document.getElementById('inputNomeArea').value = areaAtualContexto.nome;
        document.getElementById('inputNomeArea').placeholder = areaAtualContexto.nome;
        document.querySelector('.btn-criar').textContent = 'Salvar';
        document.getElementById('areaIdEdicao').value = areaAtualContexto.id;
        document.getElementById('modalArea').style.display = 'flex';

        setTimeout(() => {
            document.getElementById('inputNomeArea').focus();
            document.getElementById('inputNomeArea').select();
            lucide.createIcons();
        }, 10);
    }

    // Compartilhamento

    function carregarAreasCompartilhamento(areas) {
        const container = document.querySelector('.lista-areas-compartilhar');
        container.innerHTML = ''; // limpa antes de gerar

        areas.forEach(area => {
            const div = document.createElement('div');
            div.classList.add('area-item-compartilhar');
            div.onclick = () => selecionarAreaCompartilhar(area.id);

            const input = document.createElement('input');
            input.type = 'radio';
            input.name = 'areaCompartilhar';
            input.id = `area-${area.id}`;
            input.value = area.id;
            input.onchange = atualizarSelecaoArea;

            const label = document.createElement('label');
            label.htmlFor = input.id;
            label.textContent = area.nome;

            div.appendChild(input);
            div.appendChild(label);
            container.appendChild(div);
        });
    }

    function abrirModalCompartilhar() {
        document.getElementById('modalCompartilhar').style.display = 'flex';
        areaSelecionadaCompartilhar = null;

        const areas = Array.from(document.querySelectorAll('.area-card'))
            .filter(card => card.dataset.id && card.dataset.nome)
            .map(card => ({
                id: card.dataset.id,
                nome: card.dataset.nome
        }));

        carregarAreasCompartilhamento(areas)

        // Desmarca todos os radios
        document.querySelectorAll('input[name="areaCompartilhar"]').forEach(radio => {
            radio.checked = false;
        });

        // Remove seleção visual de todos
        document.querySelectorAll('.area-item-compartilhar').forEach(item => {
            item.classList.remove('selecionada');
        });

        // Desabilita todos os botões de compartilhamento
        document.getElementById('btnGoogle').disabled = true;
        document.getElementById('btnMicrosoft').disabled = true;
        document.getElementById('btnGithub').disabled = true;
        document.getElementById('btnLink').disabled = true;

        setTimeout(() => lucide.createIcons(), 10);
    }

    function fecharModalCompartilhar() {
        document.getElementById('modalCompartilhar').style.display = 'none';
        areaSelecionadaCompartilhar = null;
    }

    function selecionarAreaCompartilhar(areaId) {
        areaSelecionadaCompartilhar = areaId;

        // Marca o radio correspondente
        const radio = document.getElementById('area-' + areaId);
        if (radio) {
            radio.checked = true;
        }

        // Atualiza visual
        atualizarSelecaoArea();
    }

    function atualizarSelecaoArea() {
        const radioSelecionado = document.querySelector('input[name="areaCompartilhar"]:checked');

        // Remove seleção visual de todos
        document.querySelectorAll('.area-item-compartilhar').forEach(item => {
            item.classList.remove('selecionada');
        });

        if (radioSelecionado) {
            areaSelecionadaCompartilhar = radioSelecionado.value;

            // Adiciona classe selecionada ao item clicado
            radioSelecionado.closest('.area-item-compartilhar').classList.add('selecionada');

            // Habilita os botões de compartilhamento
            document.getElementById('btnGoogle').disabled = false;
            document.getElementById('btnMicrosoft').disabled = false;
            document.getElementById('btnGithub').disabled = false;
            document.getElementById('btnLink').disabled = false;
        } else {
            areaSelecionadaCompartilhar = null;

            // Desabilita os botões de compartilhamento
            document.getElementById('btnGoogle').disabled = true;
            document.getElementById('btnMicrosoft').disabled = true;
            document.getElementById('btnGithub').disabled = true;
            document.getElementById('btnLink').disabled = true;
        }
    }

    function compartilharVia(metodo) {
        if (!areaSelecionadaCompartilhar) {
            alert('Selecione uma área para compartilhar');
            return;
        }

        fetch('/areasTrabalho/compartilhar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                areaId: areaSelecionadaCompartilhar,
                metodo: metodo
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert(`Área compartilhada via ${metodo.toUpperCase()}!`);
                fecharModalCompartilhar();
            } else {
                alert('Erro ao compartilhar a área: ' + data.message);
            }
        })
        .catch(err => {
            console.error(err);
            alert('Erro ao compartilhar a área. Tente novamente.');
        });

    }

    function gerarLinkCompartilhamento() {
        if (!areaSelecionadaCompartilhar) {
            alert('Selecione uma área para compartilhar');
            return;
        }

        fetch(`/areasTrabalho/gerar-link/${areaSelecionadaCompartilhar}`)
            .then(res => res.json())
            .then(data => {
                if (data.link) {
                    navigator.clipboard.writeText(data.link)
                        .then(() => alert('Link copiado para a área de transferência!'))
                        .catch(() => alert('Link gerado: ' + data.link));
                    fecharModalCompartilhar();
                } else {
                    alert('Erro ao gerar o link.');
                }
            })
            .catch(err => {
                console.error(err);
                alert('Erro ao gerar o link. Tente novamente.');
            });
    }

    // Exclusão de áreas
    function abrirModalExcluir() {
        document.getElementById('modalExcluir').style.display = 'flex';
        areasSelecionadasExcluir = [];

        const areas = Array.from(document.querySelectorAll('.area-card'))
            .filter(card => card.dataset.id && card.dataset.nome)
            .map(card => ({
                id: card.dataset.id,
                nome: card.dataset.nome
        }));

        // Preenche dinamicamente
        popularListaAreasExcluir(areas); // 'areas' deve ser a lista atual de áreas do usuário

        // Desabilita botão de excluir
        const btnExcluir = document.getElementById('btnConfirmarExclusao');
        btnExcluir.disabled = true;

        setTimeout(() => lucide.createIcons(), 10);
    }

    function fecharModalExcluir() {
        document.getElementById('modalExcluir').style.display = 'none';
        areasSelecionadasExcluir = [];
    }

    function atualizarSelecaoExclusao() {
        const checkboxesSelecionados = document.querySelectorAll('input[name="areaExcluir"]:checked');
        areasSelecionadasExcluir = Array.from(checkboxesSelecionados).map(cb => cb.value);

        // Remove seleção visual de todos
        document.querySelectorAll('.area-item-excluir').forEach(item => {
            item.classList.remove('selecionada');
        });

        // Adiciona seleção visual aos marcados
        checkboxesSelecionados.forEach(checkbox => {
            checkbox.closest('.area-item-excluir').classList.add('selecionada');
        });

        // Habilita/desabilita botão de excluir
        const btnExcluir = document.getElementById('btnConfirmarExclusao');
        btnExcluir.disabled = areasSelecionadasExcluir.length === 0;

        // Atualiza texto do botão
        if (areasSelecionadasExcluir.length > 0) {
            btnExcluir.innerHTML = `<i data-lucide="trash-2"></i> Excluir ${areasSelecionadasExcluir.length} ${areasSelecionadasExcluir.length === 1 ? 'Área' : 'Áreas'}`;
        } else {
            btnExcluir.innerHTML = '<i data-lucide="trash-2"></i> Excluir Selecionadas';
        }

        setTimeout(() => lucide.createIcons(), 10);
    }

    function confirmarExclusao() {
        if (areasSelecionadasExcluir.length === 0) {
            alert('Selecione pelo menos uma área para excluir');
            return;
        }

        const confirmacao = confirm(`Tem certeza que deseja excluir ${areasSelecionadasExcluir.length} ${areasSelecionadasExcluir.length === 1 ? 'área' : 'áreas'}?\n\nEsta ação não pode ser desfeita.`);

        if (!confirmacao) return;

        fetch('/areasTrabalho/excluir', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ids: areasSelecionadasExcluir })
        })
        .then(res => {
            if (!res.ok) throw new Error('Erro ao excluir áreas');
            return res.json();
        })
        .then(resultado => {
            // Remove os cards da tela
            areasSelecionadasExcluir.forEach(areaId => {
                const card = document.querySelector(`.area-card[data-id="${areaId}"]`);
                if (card) card.remove();
            });
            alert(`${areasSelecionadasExcluir.length} ${areasSelecionadasExcluir.length === 1 ? 'área excluída' : 'áreas excluídas'} com sucesso!`);
            fecharModalExcluir();
        })
        .catch(err => {
            alert(err.message);
        });
    }

    function popularListaAreasExcluir(areas) {
        const lista = document.getElementById('listaAreasExcluir');
        lista.innerHTML = ''; // limpa antes

        areas.forEach(area => {
            const item = document.createElement('div');
            item.className = 'area-item-excluir';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.name = 'areaExcluir';
            checkbox.id = 'excluir-' + area.id;
            checkbox.value = area.id;
            checkbox.onchange = atualizarSelecaoExclusao;
            checkbox.onclick = (event) => event.stopPropagation(); // evita duplo clique

            const label = document.createElement('label');
            label.setAttribute('for', 'excluir-' + area.id);
            label.textContent = area.nome;

            // Clique no item ignora label e checkbox
            item.onclick = (event) => {
                if (event.target !== checkbox && event.target !== label) {
                    checkbox.checked = !checkbox.checked;
                    atualizarSelecaoExclusao();
                }
            };

            item.appendChild(checkbox);
            item.appendChild(label);
            lista.appendChild(item);
        });
    }

    // Gerenciamento de áreas
    function abrirModalGerenciamento() {
        document.getElementById('modalGerenciamento').style.display = 'flex';
        areaSelecionadaGerenciar = null;
        nomeAreaGerenciar = null;

        // Mostra etapa de seleção
        document.getElementById('etapaSelecaoArea').style.display = 'block';
        document.getElementById('etapaDetalhesArea').style.display = 'none';
        document.getElementById('etapaMembros').style.display = 'none';

        // Desmarca todos os radios
        document.querySelectorAll('input[name="areaGerenciar"]').forEach(radio => {
            radio.checked = false;
        });

        // Remove seleção visual de todos
        document.querySelectorAll('.area-item-gerenciar').forEach(item => {
            item.classList.remove('selecionada');
        });

        // Desabilita botão de avançar
        document.getElementById('btnAvancarGerenciar').disabled = true;

        const listaAreas = document.querySelector('.lista-areas-gerenciar');
        listaAreas.innerHTML = ''; // limpa antes de preencher

        const areas = Array.from(document.querySelectorAll('.area-card'))
            .filter(card => card.dataset.id && card.dataset.nome)
            .map(card => ({
                id: card.dataset.id,
                nome: card.dataset.nome
        }));

        areas.forEach(area => {
            const div = document.createElement('div');
            div.classList.add('area-item-gerenciar');
            div.onclick = () => selecionarAreaGerenciar(area.id);

            div.innerHTML = `
                <div class="info-area">
                    <input type="radio" name="areaGerenciar" id="gerenciar-${area.id}" value="${area.id}" onchange="atualizarSelecaoGerenciar()">
                    <label for="gerenciar-${area.id}">${area.nome}</label>
                    ${area.compartilhado ? `<div class="badge-compartilhado-mini"><i data-lucide="share-2"></i></div>` : ''}
                </div>
            `;
            listaAreas.appendChild(div);
        });


        setTimeout(() => lucide.createIcons(), 10);
    }

    function fecharModalGerenciamento() {
        document.getElementById('modalGerenciamento').style.display = 'none';
        areaSelecionadaGerenciar = null;
        nomeAreaGerenciar = null;
    }

    function selecionarAreaGerenciar(areaId) {
        const radio = document.getElementById('gerenciar-' + areaId);
        if (radio) {
            radio.checked = true;
            atualizarSelecaoGerenciar();
        }
    }

    function atualizarSelecaoGerenciar() {
        const radioSelecionado = document.querySelector('input[name="areaGerenciar"]:checked');

        // Remove seleção visual de todos
        document.querySelectorAll('.area-item-gerenciar').forEach(item => {
            item.classList.remove('selecionada');
        });

        if (radioSelecionado) {
            areaSelecionadaGerenciar = radioSelecionado.value;
            nomeAreaGerenciar = radioSelecionado.nextElementSibling.textContent;

            // Adiciona classe selecionada ao item clicado
            radioSelecionado.closest('.area-item-gerenciar').classList.add('selecionada');

            // Habilita botão de avançar
            document.getElementById('btnAvancarGerenciar').disabled = false;
        } else {
            areaSelecionadaGerenciar = null;
            nomeAreaGerenciar = null;

            // Desabilita botão de avançar
            document.getElementById('btnAvancarGerenciar').disabled = true;
        }
    }

    function avancarParaDetalhes() {
        if (!areaSelecionadaGerenciar) {
            alert('Selecione uma área para gerenciar');
            return;
        }

        console.log('Carregando detalhes da área:', areaSelecionadaGerenciar);
        // Aqui você faria a chamada ao backend para carregar os dados da área

        // Atualiza título
        document.getElementById('tituloAreaDetalhes').textContent = nomeAreaGerenciar;

        // Troca de etapa
        document.getElementById('etapaSelecaoArea').style.display = 'none';
        document.getElementById('etapaDetalhesArea').style.display = 'block';

        setTimeout(() => lucide.createIcons(), 10);
    }

    function voltarParaSelecao() {
        document.getElementById('etapaDetalhesArea').style.display = 'none';
        document.getElementById('etapaSelecaoArea').style.display = 'block';

        setTimeout(() => lucide.createIcons(), 10);
    }

    function abrirMembros() {
        if (!areaSelecionadaGerenciar) return;

        const listaMembros = document.getElementById('listaMembros');
        listaMembros.innerHTML = ''; // limpa lista
        
        fetch(`/areasTrabalho/${areaSelecionadaGerenciar}/membros`)
            .then(res => res.json())
            .then(membros => {

                    if (!membros || membros.length === 0) return;

                    // Define quem é o usuário logado e o criador da área
                    
                    membroAtualId = parseInt(/*[[${usuarioId}]]*/ '0');
                    // Por agora
                    membroCriadorId = membroAtualId;

                    listaMembros.innerHTML = '';

                membros.forEach(membro => {
                    const div = document.createElement('div');
                    div.classList.add('membro-item');
                    div.setAttribute('data-membro-id', membro.id);

                    const btnAlterar = membro.id !== membroAtualId ? 
                        `<button class="btn-acao-membro" onclick="abrirModalPermissao('${membro.id}','${membro.nome}','${membro.permissao}')">
                            <i data-lucide="shield"></i> Alterar Permissão
                        </button>` :
                        `<button class="btn-acao-membro" disabled title="Você não pode alterar suas próprias permissões">
                            <i data-lucide="shield"></i> Alterar Permissão
                        </button>`;

                    const btnRemover = membro.id !== membroCriadorId ? 
                        `<button class="btn-acao-membro remover" onclick="removerMembro('${membro.id}','${membro.nome}')">
                            <i data-lucide="user-minus"></i> Remover
                        </button>` :
                        `<button class="btn-acao-membro remover" disabled title="O criador não pode ser removido">
                            <i data-lucide="user-minus"></i> Remover
                        </button>`;

                    div.innerHTML = `
                        <div class="membro-header">
                            <div class="membro-info">
                                <div class="membro-nome">${membro.nome}</div>
                                <div class="membro-email">${membro.email}</div>
                            </div>
                            <div class="membro-badges">
                                <span class="badge-permissao ${membro.permissao}" data-permissao="${membro.permissao}">
                                    ${membro.permissao === 'editar' ? 'Pode editar' : 'Pode visualizar'}
                                </span>
                            </div>
                        </div>
                        <div class="membro-acoes">
                            ${btnAlterar}
                            ${btnRemover}
                        </div>
                    `;
                    listaMembros.appendChild(div);
                });

                // Atualiza contador de membros
                document.getElementById('contadorMembros').textContent = membros.length;
                setTimeout(() => lucide.createIcons(), 10);
            })
            .catch(err => console.error(err));

        // Troca de etapa
        document.getElementById('etapaDetalhesArea').style.display = 'none';
        document.getElementById('etapaMembros').style.display = 'block';
    }

    function voltarParaDetalhes() {
        document.getElementById('etapaMembros').style.display = 'none';
        document.getElementById('etapaDetalhesArea').style.display = 'block';

        setTimeout(() => lucide.createIcons(), 10);
    }

    function abrirSolicitacoes() {
        console.log('Carregando solicitações da área:', areaSelecionadaGerenciar);
        // Aqui você implementaria a tela de solicitações
        alert('Funcionalidade de Solicitações em desenvolvimento');
    }

    // Gerenciamento de permissões de membros
    function abrirModalPermissao(membroId, membroNome, permissaoAtual) {
        membroAtualPermissao = { id: membroId, nome: membroNome, permissaoAtual: permissaoAtual };

        document.getElementById('tituloModalPermissao').textContent = `Alterar Permissão`;
        document.getElementById('descModalPermissao').textContent = `Selecione o nível de permissão para ${membroNome}`;

        // Marca a permissão atual
        document.querySelectorAll('input[name="permissaoMembro"]').forEach(radio => {
            radio.checked = false;
        });

        const radioAtual = document.getElementById('perm-' + permissaoAtual);
        if (radioAtual) {
            radioAtual.checked = true;
            radioAtual.closest('.opcao-permissao').classList.add('selecionada');
        }

        document.getElementById('modalPermissao').style.display = 'flex';
        setTimeout(() => lucide.createIcons(), 10);
    }

    function fecharModalPermissao() {
        document.getElementById('modalPermissao').style.display = 'none';
        membroAtualPermissao = { id: null, nome: null, permissaoAtual: null };
    }

    function selecionarPermissao(permissao) {
        const radio = document.getElementById('perm-' + permissao);
        if (radio) {
            radio.checked = true;

            // Remove seleção visual de todos
            document.querySelectorAll('.opcao-permissao').forEach(opcao => {
                opcao.classList.remove('selecionada');
            });

            // Adiciona seleção visual ao clicado
            radio.closest('.opcao-permissao').classList.add('selecionada');
        }
    }

    function salvarPermissao() {
        const permissaoSelecionada = document.querySelector('input[name="permissaoMembro"]:checked');

        if (!permissaoSelecionada) {
            alert('Selecione uma permissão');
            return;
        }

        const novaPermissao = permissaoSelecionada.value;

        console.log('Alterando permissão do membro:', membroAtualPermissao.id, 'para:', novaPermissao);
        // Aqui você implementa a chamada ao backend

        // Atualiza a UI
        const membroCard = document.querySelector(`.membro-item[data-membro-id="${membroAtualPermissao.id}"]`);
        if (membroCard) {
            const badgePermissao = membroCard.querySelector('.badge-permissao');
            if (badgePermissao) {
                // Remove classes antigas
                badgePermissao.classList.remove('criador', 'editar');
                badgePermissao.setAttribute('data-permissao', novaPermissao);

                // Atualiza texto e classe
                if (novaPermissao === 'editar') {
                    badgePermissao.textContent = 'Pode editar';
                    badgePermissao.classList.add('editar');
                } else if (novaPermissao === 'visualizar') {
                    badgePermissao.textContent = 'Pode visualizar';
                }
            }

            // Atualiza o botão de alterar permissão para refletir nova permissão
            const btnAlterar = membroCard.querySelector('.btn-acao-membro:not(.remover)');
            if (btnAlterar) {
                btnAlterar.setAttribute('onclick', `abrirModalPermissao('${membroAtualPermissao.id}', '${membroAtualPermissao.nome}', '${novaPermissao}')`);
            }
        }

        alert(`Permissão de ${membroAtualPermissao.nome} alterada para "${novaPermissao === 'editar' ? 'Pode editar' : 'Pode visualizar'}"`);
        fecharModalPermissao();
    }

    function removerMembro(membroId, membroNome) {
        const confirmacao = confirm(`Tem certeza que deseja remover ${membroNome} desta área?\n\nEle perderá acesso a todas as tarefas e informações.`);

        if (confirmacao) {
            console.log('Removendo membro:', membroId);
            // Aqui você implementa a chamada ao backend

            // Remove o card da tela
            const membroCard = document.querySelector(`.membro-item[data-membro-id="${membroId}"]`);
            if (membroCard) {
                membroCard.style.opacity = '0';
                membroCard.style.transform = 'translateX(-20px)';

                setTimeout(() => {
                    membroCard.remove();

                    // Atualiza contador de membros
                    const contador = document.getElementById('contadorMembros');
                    if (contador) {
                        const numeroAtual = parseInt(contador.textContent);
                        contador.textContent = numeroAtual - 1;
                    }
                }, 200);
            }

            alert(`${membroNome} foi removido da área de trabalho.`);
        }
    }

    // Fecha o menu de contexto ao clicar em qualquer lugar
    document.addEventListener('click', function(event) {
        const menu = document.getElementById('menuContexto');
        if (menu && !menu.contains(event.target)) {
            fecharMenuContexto();
        }
    });

    // Inicializa os ícones do Lucide ao carregar a página
    document.addEventListener('DOMContentLoaded', function() {
        lucide.createIcons();
    });
</script>
</body>
</html>